parameters:
  name: ''
  graphics: 'NANOVG'

steps:
  - task: DownloadPipelineArtifact@0
    continueOnError: true
    inputs:
      artifactName: 'MAC_VST2_${{parameters.name}}_${{parameters.graphics}}'
      targetPath: $(Build.BinariesDirectory)
    displayName: Download MAC_VST2_${{parameters.name}}_${{parameters.graphics}}
    condition: eq(variables.build_vst2, True)

  - task: DownloadPipelineArtifact@0
    continueOnError: true
    inputs:
      artifactName: 'MAC_VST3_${{parameters.name}}_${{parameters.graphics}}'
      targetPath: $(Build.BinariesDirectory)
    displayName: Download MAC_VST3_${{parameters.name}}_${{parameters.graphics}}
    condition: eq(variables.build_vst3, True)
  
  # - task: DownloadPipelineArtifact@0
  #   continueOnError: true
  #   inputs:
  #     artifactName: 'MAC_AAX_${{parameters.name}}_${{parameters.graphics}}'
  #     targetPath: $(Build.BinariesDirectory)
  #   displayName: Download MAC_AAX_${{parameters.name}}_${{parameters.graphics}}
  #   condition: eq(variables.build_aax, True)

  - task: DownloadPipelineArtifact@0
    continueOnError: true
    inputs:
      artifactName: 'MAC_AU_${{parameters.name}}_${{parameters.graphics}}'
      targetPath: $(Build.BinariesDirectory)
    displayName: Download MAC_AU_${{parameters.name}}_${{parameters.graphics}}
    condition: eq(variables.build_auv2, True)

  - task: ExtractFiles@1
    inputs:
      archiveFilePatterns: '$(Build.BinariesDirectory)/*.zip'
      destinationFolder: $(Build.SourcesDirectory)
      cleanDestinationFolder: false
    displayName: Extract zip file if it exists

  - bash: |
      curl -L "https://github.com/Tracktion/pluginval/releases/download/latest_release/pluginval_macOS.zip" -o pluginval.zip
      unzip pluginval
    displayName: Install PluginVal

  - bash: |
      git clone --recursive https://github.com/steinbergmedia/vst3sdk.git VST3_SDK
      mkdir VST3_BUILD
      cd VST3_BUILD
      cmake ../VST3_SDK -DCMAKE_BUILD_TYPE=Release
      make validator
      mv bin/Release/validator $(Build.SourcesDirectory)
    displayName: Download VST3 SDK, build validator
    condition: eq(variables.build_vst3, True)

  - bash: |
      pluginval.app/Contents/MacOS/pluginval --validate-in-process --skip-gui-tests --output-dir "./bin" --validate "${{parameters.name}}.vst" || exit 1
    displayName: Pluginval - Test ${{parameters.name}} VST2
    condition: eq(variables.build_vst2, True)

  - bash: |
      pluginval.app/Contents/MacOS/pluginval --validate-in-process --skip-gui-tests --output-dir "./bin" --validate "${{parameters.name}}.vst3" || exit 1
    displayName: Pluginval - Test ${{parameters.name}} VST3
    condition: eq(variables.build_vst3, True)

  - bash: |
      validator ${{parameters.name}}.vst3
    displayName: VST3 Validator - Test ${{parameters.name}} VST3
    condition: eq(variables.build_vst3, True)

  - bash: |
      mkdir -p ~/Library/Audio/Plug-Ins/Components/
      mv ${{parameters.name}}.component ~/Library/Audio/Plug-Ins/Components/
    displayName: Install AUv2

  - bash: |
      cd scripts
      ./validate_audiounit.sh
    displayName: AUVAL - Test ${{parameters.name}} AUv2
    condition: eq(variables.build_auv2, True)

  # - bash: |
  #     pluginval.app/Contents/MacOS/pluginval --validate-in-process --skip-gui-tests --output-dir "./bin" --validate ${{parameters.name}}.component || exit 1
  #   displayName: Pluginval - Test ${{parameters.name}} AUv2
  #   condition: eq(variables.build_auv2, True)
